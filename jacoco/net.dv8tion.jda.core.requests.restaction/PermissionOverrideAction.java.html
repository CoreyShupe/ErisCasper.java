<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionOverrideAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ErisCasper.java</a> &gt; <a href="index.source.html" class="el_package">net.dv8tion.jda.core.requests.restaction</a> &gt; <span class="el_source">PermissionOverrideAction.java</span></div><h1>PermissionOverrideAction.java</h1><pre class="source lang-java linenums">/*
 *     Copyright 2015-2018 Austin Keener &amp; Michael Ritter &amp; Florian Spieß
 *     Copyright 2018-2018 &quot;Princess&quot; Lana Samson
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.dv8tion.jda.core.requests.restaction;

import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.function.BooleanSupplier;
import net.dv8tion.jda.core.JDA;
import net.dv8tion.jda.core.Permission;
import net.dv8tion.jda.core.entities.*;
import net.dv8tion.jda.core.entities.impl.AbstractChannelImpl;
import net.dv8tion.jda.core.entities.impl.PermissionOverrideImpl;
import net.dv8tion.jda.core.requests.Request;
import net.dv8tion.jda.core.requests.Response;
import net.dv8tion.jda.core.requests.Route;
import net.dv8tion.jda.core.utils.Checks;
import okhttp3.RequestBody;
import org.json.JSONObject;

/**
 * Extension of {@link net.dv8tion.jda.core.requests.RestAction RestAction} specifically designed to
 * create a {@link net.dv8tion.jda.core.entities.PermissionOverride PermissionOverride} for a {@link
 * net.dv8tion.jda.core.entities.Channel Channel}. This extension allows setting properties before
 * executing the action.
 *
 * @since 3.0
 * @author Florian Spieß
 */
public class PermissionOverrideAction extends AuditableRestAction&lt;PermissionOverride&gt; {

<span class="nc" id="L46">  private long allow = 0;</span>
<span class="nc" id="L47">  private long deny = 0;</span>
  private final Channel channel;

  private final Member member;
  private final Role role;

  /**
   * Creates a new PermissionOverrideAction instance
   *
   * @param api The current JDA instance
   * @param route The {@link net.dv8tion.jda.core.requests.Route.CompiledRoute Route.CompiledRoute}
   *     to be used for rate limit handling
   * @param channel The target {@link net.dv8tion.jda.core.entities.Channel Channel} for the
   *     PermissionOverride
   * @param member The target {@link net.dv8tion.jda.core.entities.Member Member} that will be
   *     affected by the PermissionOverride
   */
  public PermissionOverrideAction(
      JDA api, Route.CompiledRoute route, Channel channel, Member member) {
<span class="nc" id="L66">    super(api, route);</span>
<span class="nc" id="L67">    this.channel = channel;</span>
<span class="nc" id="L68">    this.member = member;</span>
<span class="nc" id="L69">    this.role = null;</span>
<span class="nc" id="L70">  }</span>

  @Override
  public PermissionOverrideAction setCheck(BooleanSupplier checks) {
<span class="nc" id="L74">    return (PermissionOverrideAction) super.setCheck(checks);</span>
  }

  /**
   * Creates a new PermissionOverrideAction instance
   *
   * @param api The current JDA instance
   * @param route The {@link net.dv8tion.jda.core.requests.Route.CompiledRoute Route.CompiledRoute}
   *     to be used for rate limit handling
   * @param channel The target {@link net.dv8tion.jda.core.entities.Channel Channel} for the
   *     PermissionOverride
   * @param role The target {@link net.dv8tion.jda.core.entities.Role Role} that will be affected by
   *     the PermissionOverride
   */
  public PermissionOverrideAction(JDA api, Route.CompiledRoute route, Channel channel, Role role) {
<span class="nc" id="L89">    super(api, route);</span>
<span class="nc" id="L90">    this.channel = channel;</span>
<span class="nc" id="L91">    this.member = null;</span>
<span class="nc" id="L92">    this.role = role;</span>
<span class="nc" id="L93">  }</span>

  /**
   * The currently set of allowed permission bits. &lt;br&gt;
   * This value represents all &lt;b&gt;granted&lt;/b&gt; permissions in the raw bitwise representation.
   *
   * &lt;p&gt;Use {@link #getAllowedPermissions()} to retrieve a {@link java.util.List List} with {@link
   * net.dv8tion.jda.core.Permission Permissions} for this value
   *
   * @return long value of granted permissions
   */
  public long getAllow() {
<span class="nc" id="L105">    return allow;</span>
  }

  /**
   * Immutable list of {@link net.dv8tion.jda.core.Permission Permissions} that would be
   * &lt;b&gt;granted&lt;/b&gt; by the PermissionOverride that is created by this action.
   *
   * @return immutable list of granted {@link net.dv8tion.jda.core.Permission Permissions}
   */
  public List&lt;Permission&gt; getAllowedPermissions() {
<span class="nc" id="L115">    return Collections.unmodifiableList(Permission.getPermissions(allow));</span>
  }

  /**
   * The currently set of denied permission bits. &lt;br&gt;
   * This value represents all &lt;b&gt;denied&lt;/b&gt; permissions in the raw bitwise representation.
   *
   * &lt;p&gt;Use {@link #getDeniedPermissions()} to retrieve a {@link java.util.List List} with {@link
   * net.dv8tion.jda.core.Permission Permissions} for this value
   *
   * @return long value of denied permissions
   */
  public long getDeny() {
<span class="nc" id="L128">    return deny;</span>
  }

  /**
   * Immutable list of {@link net.dv8tion.jda.core.Permission Permissions} that would be
   * &lt;b&gt;denied&lt;/b&gt; by the PermissionOverride that is created by this action.
   *
   * @return immutable list of denied {@link net.dv8tion.jda.core.Permission Permissions}
   */
  public List&lt;Permission&gt; getDeniedPermissions() {
<span class="nc" id="L138">    return Collections.unmodifiableList(Permission.getPermissions(deny));</span>
  }

  /**
   * The currently set of inherited permission bits. &lt;br&gt;
   * This value represents all permissions that are not explicitly allowed or denied in their raw
   * bitwise representation. &lt;br&gt;
   * Inherited Permissions are permissions that are defined by other rules from maybe other
   * PermissionOverrides or a Role.
   *
   * &lt;p&gt;Use {@link #getInheritedPermissions()} to retrieve a {@link java.util.List List} with {@link
   * net.dv8tion.jda.core.Permission Permissions} for this value
   *
   * @return long value of inherited permissions
   */
  public long getInherited() {
<span class="nc" id="L154">    return ~allow &amp; ~deny;</span>
  }

  /**
   * Immutable list of {@link net.dv8tion.jda.core.Permission Permissions} that would be
   * &lt;b&gt;inherited&lt;/b&gt; from other permission holders. &lt;br&gt;
   * Permissions returned are not explicitly granted or denied!
   *
   * @return immutable list of inherited {@link net.dv8tion.jda.core.Permission Permissions}
   * @see #getInherited()
   */
  public List&lt;Permission&gt; getInheritedPermissions() {
<span class="nc" id="L166">    return Permission.getPermissions(getInherited());</span>
  }

  /**
   * Whether this Action will create a {@link net.dv8tion.jda.core.entities.PermissionOverride
   * PermissionOverride} for a {@link net.dv8tion.jda.core.entities.Member Member} or not
   *
   * @return True, if this is targeting a Member If this is {@code false} it is targeting a {@link
   *     net.dv8tion.jda.core.entities.Role Role}. ({@link #isRole()})
   */
  public boolean isMember() {
<span class="nc bnc" id="L177" title="All 2 branches missed.">    return member != null;</span>
  }

  /**
   * Whether this Action will create a {@link net.dv8tion.jda.core.entities.PermissionOverride
   * PermissionOverride} for a {@link net.dv8tion.jda.core.entities.Role Role} or not
   *
   * @return True, if this is targeting a Role. If this is {@code false} it is targeting a {@link
   *     net.dv8tion.jda.core.entities.Member Member}. ({@link #isMember()})
   */
  public boolean isRole() {
<span class="nc bnc" id="L188" title="All 2 branches missed.">    return role != null;</span>
  }

  /**
   * Sets the value of explicitly granted permissions using the bitwise representation of a set of
   * {@link net.dv8tion.jda.core.Permission Permissions}. &lt;br&gt;
   * This value can be retrieved through {@link
   * net.dv8tion.jda.core.Permission#getRaw(net.dv8tion.jda.core.Permission...)
   * Permissions.getRaw(Permission...)}! &lt;br&gt;
   * &lt;b&gt;Note: Permissions not marked as {@link net.dv8tion.jda.core.Permission#isChannel()
   * isChannel()} will have no affect!&lt;/b&gt;
   *
   * @param allowBits The &lt;b&gt;positive&lt;/b&gt; bits representing the granted permissions for the new
   *     PermissionOverride
   * @throws java.lang.IllegalArgumentException If the provided bits are negative or higher than
   *     {@link net.dv8tion.jda.core.Permission#ALL_PERMISSIONS Permission.ALL_PERMISSIONS}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setAllow(long allowBits) {
<span class="nc" id="L207">    Checks.notNegative(allowBits, &quot;Granted permissions value&quot;);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">    Checks.check(</span>
        allowBits &lt;= Permission.ALL_PERMISSIONS,
        &quot;Specified allow value may not be greater than a full permission set&quot;);
<span class="nc" id="L211">    this.allow = allowBits;</span>
<span class="nc" id="L212">    return this;</span>
  }

  /**
   * Sets the value of explicitly granted permissions using a Collection of {@link
   * net.dv8tion.jda.core.Permission Permissions}. &lt;br&gt;
   * &lt;b&gt;Note: Permissions not marked as {@link net.dv8tion.jda.core.Permission#isChannel()
   * isChannel()} will have no affect!&lt;/b&gt;
   *
   * @param permissions The Collection of Permissions representing the granted permissions for the
   *     new PermissionOverride. &lt;br&gt;
   *     If the provided value is {@code null} the permissions are reset to the default of none
   * @throws java.lang.IllegalArgumentException If the any of the specified Permissions is {@code
   *     null}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setAllow(Collection&lt;Permission&gt; permissions) {
<span class="nc bnc" id="L229" title="All 4 branches missed.">    if (permissions == null || permissions.isEmpty()) return setAllow(0);</span>
<span class="nc" id="L230">    checkNull(permissions, &quot;Permission&quot;);</span>
<span class="nc" id="L231">    return setAllow(Permission.getRaw(permissions));</span>
  }

  /**
   * Sets the value of explicitly granted permissions using a set of {@link
   * net.dv8tion.jda.core.Permission Permissions}. &lt;br&gt;
   * &lt;b&gt;Note: Permissions not marked as {@link net.dv8tion.jda.core.Permission#isChannel()
   * isChannel()} will have no affect!&lt;/b&gt;
   *
   * @param permissions The Permissions representing the granted permissions for the new
   *     PermissionOverride. &lt;br&gt;
   *     If the provided value is {@code null} the permissions are reset to the default of none
   * @throws java.lang.IllegalArgumentException If the any of the specified Permissions is {@code
   *     null}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setAllow(Permission... permissions) {
<span class="nc bnc" id="L248" title="All 4 branches missed.">    if (permissions == null || permissions.length &lt; 1) return setAllow(0);</span>
<span class="nc" id="L249">    checkNull(permissions, &quot;Permission&quot;);</span>
<span class="nc" id="L250">    return setAllow(Permission.getRaw(permissions));</span>
  }

  /**
   * Sets the value of explicitly denied permissions using the bitwise representation of a set of
   * {@link net.dv8tion.jda.core.Permission Permissions}. &lt;br&gt;
   * This value can be retrieved through {@link
   * net.dv8tion.jda.core.Permission#getRaw(net.dv8tion.jda.core.Permission...)
   * Permissions.getRaw(Permission...)}! &lt;br&gt;
   * &lt;b&gt;Note: Permissions not marked as {@link net.dv8tion.jda.core.Permission#isChannel()
   * isChannel()} will have no affect!&lt;/b&gt;
   *
   * @param denyBits The &lt;b&gt;positive&lt;/b&gt; bits representing the denied permissions for the new
   *     PermissionOverride
   * @throws java.lang.IllegalArgumentException If the provided bits are negative or higher than
   *     {@link net.dv8tion.jda.core.Permission#ALL_PERMISSIONS Permission.ALL_PERMISSIONS}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setDeny(long denyBits) {
<span class="nc" id="L269">    Checks.notNegative(denyBits, &quot;Denied permissions value&quot;);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">    Checks.check(</span>
        denyBits &lt;= Permission.ALL_PERMISSIONS,
        &quot;Specified allow value may not be greater than a full permission set&quot;);
<span class="nc" id="L273">    this.deny = denyBits;</span>
<span class="nc" id="L274">    return this;</span>
  }

  /**
   * Sets the value of explicitly denied permissions using a Collection of {@link
   * net.dv8tion.jda.core.Permission Permissions}. &lt;br&gt;
   * &lt;b&gt;Note: Permissions not marked as {@link net.dv8tion.jda.core.Permission#isChannel()
   * isChannel()} will have no affect!&lt;/b&gt;
   *
   * @param permissions The Collection of Permissions representing the denied permissions for the
   *     new PermissionOverride. &lt;br&gt;
   *     If the provided value is {@code null} the permissions are reset to the default of none
   * @throws java.lang.IllegalArgumentException If the any of the specified Permissions is {@code
   *     null}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setDeny(Collection&lt;Permission&gt; permissions) {
<span class="nc bnc" id="L291" title="All 4 branches missed.">    if (permissions == null || permissions.isEmpty()) return setDeny(0);</span>
<span class="nc" id="L292">    checkNull(permissions, &quot;Permission&quot;);</span>
<span class="nc" id="L293">    return setDeny(Permission.getRaw(permissions));</span>
  }

  /**
   * Sets the value of explicitly denied permissions using a set of {@link
   * net.dv8tion.jda.core.Permission Permissions}. &lt;br&gt;
   * &lt;b&gt;Note: Permissions not marked as {@link net.dv8tion.jda.core.Permission#isChannel()
   * isChannel()} will have no affect!&lt;/b&gt;
   *
   * @param permissions The Permissions representing the denied permissions for the new
   *     PermissionOverride. &lt;br&gt;
   *     If the provided value is {@code null} the permissions are reset to the default of none
   * @throws java.lang.IllegalArgumentException If the any of the specified Permissions is {@code
   *     null}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setDeny(Permission... permissions) {
<span class="nc bnc" id="L310" title="All 4 branches missed.">    if (permissions == null || permissions.length &lt; 1) return setDeny(0);</span>
<span class="nc" id="L311">    checkNull(permissions, &quot;Permission&quot;);</span>
<span class="nc" id="L312">    return setDeny(Permission.getRaw(permissions));</span>
  }

  /**
   * Combination of {@link #setAllow(long)} and {@link #setDeny(long)}
   *
   * @param allowBits A non-negative bitwise representation of granted Permissions
   * @param denyBits A non-negative bitwise representation of denied Permissions
   * @throws java.lang.IllegalArgumentException If any of the provided bits are negative or higher
   *     than {@link net.dv8tion.jda.core.Permission#ALL_PERMISSIONS Permission.ALL_PERMISSIONS}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setPermissions(long allowBits, long denyBits) {
<span class="nc" id="L325">    setAllow(allowBits);</span>
<span class="nc" id="L326">    setDeny(denyBits);</span>
<span class="nc" id="L327">    return this;</span>
  }

  /**
   * Combination of {@link #setAllow(java.util.Collection)} and {@link
   * #setDeny(java.util.Collection)} &lt;br&gt;
   * If a passed collection is {@code null} it resets the represented value to {@code 0} - no
   * permission specifics.
   *
   * @param grantPermissions A Collection of {@link net.dv8tion.jda.core.Permission Permissions}
   *     representing all explicitly granted Permissions for the PermissionOverride
   * @param denyPermissions A Collection of {@link net.dv8tion.jda.core.Permission Permissions}
   *     representing all explicitly denied Permissions for the PermissionOverride
   * @throws java.lang.IllegalArgumentException If the any of the specified Permissions is {@code
   *     null}
   * @return The current PermissionOverrideAction - for chaining convenience
   */
  public PermissionOverrideAction setPermissions(
      Collection&lt;Permission&gt; grantPermissions, Collection&lt;Permission&gt; denyPermissions) {
<span class="nc" id="L346">    setAllow(grantPermissions);</span>
<span class="nc" id="L347">    setDeny(denyPermissions);</span>
<span class="nc" id="L348">    return this;</span>
  }

  @Override
  protected RequestBody finalizeData() {
<span class="nc" id="L353">    JSONObject object = new JSONObject();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">    object.put(&quot;type&quot;, isRole() ? &quot;role&quot; : &quot;member&quot;);</span>
<span class="nc" id="L355">    object.put(&quot;allow&quot;, allow);</span>
<span class="nc" id="L356">    object.put(&quot;deny&quot;, deny);</span>

<span class="nc" id="L358">    return getRequestBody(object);</span>
  }

  @Override
  protected void handleResponse(Response response, Request&lt;PermissionOverride&gt; request) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">    if (!response.isOk()) {</span>
<span class="nc" id="L364">      request.onFailure(response);</span>
<span class="nc" id="L365">      return;</span>
    }

<span class="nc" id="L368">    JSONObject object = response.getObject();</span>
<span class="nc" id="L369">    boolean isMember = isMember();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">    long id = isMember ? member.getUser().getIdLong() : role.getIdLong();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">    PermissionOverrideImpl override =</span>
        new PermissionOverrideImpl(channel, id, isMember ? member : role)
<span class="nc" id="L373">            .setAllow(allow)</span>
<span class="nc" id="L374">            .setDeny(deny);</span>

<span class="nc" id="L376">    ((AbstractChannelImpl&lt;?&gt;) channel).getOverrideMap().put(id, override);</span>

<span class="nc" id="L378">    request.onSuccess(override);</span>
<span class="nc" id="L379">  }</span>

  private void checkNull(Collection&lt;?&gt; collection, String name) {
<span class="nc" id="L382">    Checks.notNull(collection, name);</span>
<span class="nc" id="L383">    collection.forEach(e -&gt; Checks.notNull(e, name));</span>
<span class="nc" id="L384">  }</span>

  private &lt;T&gt; void checkNull(T[] arr, String name) {
<span class="nc" id="L387">    Checks.notNull(arr, name);</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">    for (T e : arr) Checks.notNull(e, name);</span>
<span class="nc" id="L389">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>