<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChannelAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ErisCasper.java</a> &gt; <a href="index.source.html" class="el_package">net.dv8tion.jda.core.requests.restaction</a> &gt; <span class="el_source">ChannelAction.java</span></div><h1>ChannelAction.java</h1><pre class="source lang-java linenums">/*
 *     Copyright 2015-2018 Austin Keener &amp; Michael Ritter &amp; Florian Spieß
 *     Copyright 2018-2018 &quot;Princess&quot; Lana Samson
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.dv8tion.jda.core.requests.restaction;

import java.util.Collection;
import java.util.HashSet;
import java.util.Set;
import java.util.function.BooleanSupplier;
import net.dv8tion.jda.core.Permission;
import net.dv8tion.jda.core.entities.*;
import net.dv8tion.jda.core.requests.Request;
import net.dv8tion.jda.core.requests.Response;
import net.dv8tion.jda.core.requests.Route;
import net.dv8tion.jda.core.utils.Checks;
import okhttp3.RequestBody;
import org.json.JSONArray;
import org.json.JSONObject;

/**
 * Extension of {@link net.dv8tion.jda.core.requests.RestAction RestAction} specifically designed to
 * create a {@link net.dv8tion.jda.core.entities.Channel Channel}. This extension allows setting
 * properties before executing the action.
 *
 * @since 3.0
 * @author Florian Spieß
 */
public class ChannelAction extends AuditableRestAction&lt;Channel&gt; {
<span class="nc" id="L42">  protected final Set&lt;PermOverrideData&gt; overrides = new HashSet&lt;&gt;();</span>
  protected final Guild guild;
  protected final ChannelType type;
  protected String name;
  protected Category parent;

  // --text only--
<span class="nc" id="L49">  protected String topic = null;</span>
<span class="nc" id="L50">  protected Boolean nsfw = null;</span>

  // --voice only--
<span class="nc" id="L53">  protected Integer bitrate = null;</span>
<span class="nc" id="L54">  protected Integer userlimit = null;</span>

  /**
   * Creates a new ChannelAction instance
   *
   * @param route The {@link net.dv8tion.jda.core.requests.Route.CompiledRoute CompileRoute} to use
   *     for this action
   * @param name The name for the new {@link net.dv8tion.jda.core.entities.Channel Channel}
   * @param guild The {@link net.dv8tion.jda.core.entities.Guild Guild} the channel should be
   *     created in
   * @param type What kind of channel should be created
   */
  public ChannelAction(Route.CompiledRoute route, String name, Guild guild, ChannelType type) {
<span class="nc" id="L67">    super(guild.getJDA(), route);</span>
<span class="nc" id="L68">    this.guild = guild;</span>
<span class="nc" id="L69">    this.type = type;</span>
<span class="nc" id="L70">    this.name = name;</span>
<span class="nc" id="L71">  }</span>

  @Override
  public ChannelAction setCheck(BooleanSupplier checks) {
<span class="nc" id="L75">    return (ChannelAction) super.setCheck(checks);</span>
  }

  /**
   * Sets the name for the new Channel
   *
   * @param name The not-null name for the new Channel (2-100 chars long)
   * @throws java.lang.IllegalArgumentException If the provided name is null or not between 2-100
   *     chars long
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction setName(String name) {
<span class="nc" id="L87">    Checks.notNull(name, &quot;Channel name&quot;);</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">    if (name.length() &lt; 2 || name.length() &gt; 100)</span>
<span class="nc" id="L89">      throw new IllegalArgumentException(</span>
          &quot;Provided channel name must be 2 to 100 characters in length&quot;);

<span class="nc" id="L92">    this.name = name;</span>
<span class="nc" id="L93">    return this;</span>
  }

  /**
   * Sets the {@link net.dv8tion.jda.core.entities.Category Category} for the new Channel
   *
   * @param category The parent for the new Channel
   * @throws UnsupportedOperationException If this ChannelAction is for a Category
   * @throws IllegalArgumentException If the provided category is {@code null} or not from this
   *     Guild
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction setParent(Category category) {
<span class="nc bnc" id="L106" title="All 2 branches missed.">    Checks.check(</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        category == null || category.getGuild().equals(guild), &quot;Category is not from same guild!&quot;);</span>
<span class="nc" id="L108">    this.parent = category;</span>
<span class="nc" id="L109">    return this;</span>
  }

  /**
   * Sets the topic for the new TextChannel
   *
   * @param topic The topic for the new Channel (max 1024 chars)
   * @throws UnsupportedOperationException If this ChannelAction is not for a TextChannel
   * @throws IllegalArgumentException If the provided topic is longer than 1024 chars
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction setTopic(String topic) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">    if (type != ChannelType.TEXT)</span>
<span class="nc" id="L122">      throw new UnsupportedOperationException(&quot;Can only set the topic for a TextChannel!&quot;);</span>
<span class="nc bnc" id="L123" title="All 4 branches missed.">    if (topic != null &amp;&amp; topic.length() &gt; 1024)</span>
<span class="nc" id="L124">      throw new IllegalArgumentException(&quot;Channel Topic must not be greater than 1024 in length!&quot;);</span>
<span class="nc" id="L125">    this.topic = topic;</span>
<span class="nc" id="L126">    return this;</span>
  }

  /**
   * Sets the NSFW flag for the new TextChannel
   *
   * @param nsfw The NSFW flag for the new Channel
   * @throws UnsupportedOperationException If this ChannelAction is not for a TextChannel
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction setNSFW(boolean nsfw) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">    if (type != ChannelType.TEXT)</span>
<span class="nc" id="L138">      throw new UnsupportedOperationException(&quot;Can only set nsfw for a TextChannel!&quot;);</span>
<span class="nc" id="L139">    this.nsfw = nsfw;</span>
<span class="nc" id="L140">    return this;</span>
  }

  /**
   * Adds a new Role-{@link net.dv8tion.jda.core.entities.PermissionOverride PermissionOverride} for
   * the new Channel.
   *
   * @param target The not-null {@link net.dv8tion.jda.core.entities.Role Role} or {@link
   *     net.dv8tion.jda.core.entities.Member Member} for the override
   * @param allow The granted {@link net.dv8tion.jda.core.Permission Permissions} for the override
   *     or null
   * @param deny The denied {@link net.dv8tion.jda.core.Permission Permissions} for the override or
   *     null
   * @throws java.lang.IllegalArgumentException If the specified {@link
   *     net.dv8tion.jda.core.entities.Role Role} is null or not within the same guild.
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction addPermissionOverride(
      IPermissionHolder target, Collection&lt;Permission&gt; allow, Collection&lt;Permission&gt; deny) {
<span class="nc" id="L159">    checkPermissions(allow);</span>
<span class="nc" id="L160">    checkPermissions(deny);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">    final long allowRaw = allow != null ? Permission.getRaw(allow) : 0;</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">    final long denyRaw = deny != null ? Permission.getRaw(deny) : 0;</span>

<span class="nc" id="L164">    return addPermissionOverride(target, allowRaw, denyRaw);</span>
  }

  /**
   * Adds a new Role-{@link net.dv8tion.jda.core.entities.PermissionOverride PermissionOverride} for
   * the new Channel.
   *
   * @param target The not-null {@link net.dv8tion.jda.core.entities.Role Role} for the override
   * @param allow The granted {@link net.dv8tion.jda.core.Permission Permissions} for the override
   *     Use {@link net.dv8tion.jda.core.Permission#getRawValue()} to retrieve these Permissions.
   * @param deny The denied {@link net.dv8tion.jda.core.Permission Permissions} for the override Use
   *     {@link net.dv8tion.jda.core.Permission#getRawValue()} to retrieve these Permissions.
   * @throws java.lang.IllegalArgumentException
   *     &lt;ul&gt;
   *       &lt;li&gt;If the specified {@link net.dv8tion.jda.core.entities.Role Role} is null or not
   *           within the same guild.
   *       &lt;li&gt;If one of the provided Permission values is invalid
   *     &lt;/ul&gt;
   *
   * @return The current ChannelAction, for chaining convenience
   * @see net.dv8tion.jda.core.Permission#getRawValue()
   * @see net.dv8tion.jda.core.Permission#getRaw(java.util.Collection)
   * @see net.dv8tion.jda.core.Permission#getRaw(net.dv8tion.jda.core.Permission...)
   */
  public ChannelAction addPermissionOverride(IPermissionHolder target, long allow, long deny) {
<span class="nc" id="L189">    Checks.notNull(target, &quot;Override Role&quot;);</span>
<span class="nc" id="L190">    Checks.notNegative(allow, &quot;Granted permissions value&quot;);</span>
<span class="nc" id="L191">    Checks.notNegative(deny, &quot;Denied permissions value&quot;);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">    Checks.check(</span>
        allow &lt;= Permission.ALL_PERMISSIONS,
        &quot;Specified allow value may not be greater than a full permission set&quot;);
<span class="nc bnc" id="L195" title="All 2 branches missed.">    Checks.check(</span>
        deny &lt;= Permission.ALL_PERMISSIONS,
        &quot;Specified deny value may not be greater than a full permission set&quot;);
<span class="nc" id="L198">    Checks.check(target.getGuild().equals(guild), &quot;Specified Role is not in the same Guild!&quot;);</span>

<span class="nc bnc" id="L200" title="All 2 branches missed.">    if (target instanceof Role) {</span>
<span class="nc" id="L201">      Role r = (Role) target;</span>
<span class="nc" id="L202">      long id = r.getIdLong();</span>
<span class="nc" id="L203">      overrides.add(new PermOverrideData(PermOverrideData.ROLE_TYPE, id, allow, deny));</span>
<span class="nc" id="L204">    } else {</span>
<span class="nc" id="L205">      Member m = (Member) target;</span>
<span class="nc" id="L206">      long id = m.getUser().getIdLong();</span>
<span class="nc" id="L207">      overrides.add(new PermOverrideData(PermOverrideData.MEMBER_TYPE, id, allow, deny));</span>
    }
<span class="nc" id="L209">    return this;</span>
  }

  // --voice only--
  /**
   * Sets the bitrate for the new VoiceChannel
   *
   * @param bitrate The bitrate for the new Channel (min {@code 8000}; max {@code 96000}/{@code
   *     128000} (for {@link net.dv8tion.jda.core.entities.Guild#getFeatures() VIP Guilds})) or null
   *     to use default ({@code 64000})
   * @throws UnsupportedOperationException If this ChannelAction is not for a VoiceChannel
   * @throws IllegalArgumentException If the provided bitrate is less than 8000 or greater than
   *     128000
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction setBitrate(Integer bitrate) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (type != ChannelType.VOICE)</span>
<span class="nc" id="L226">      throw new UnsupportedOperationException(&quot;Can only set the bitrate for a VoiceChannel!&quot;);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">    if (bitrate != null) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">      int maxBitrate = guild.getFeatures().contains(&quot;VIP_REGIONS&quot;) ? 128000 : 96000;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">      if (bitrate &lt; 8000) throw new IllegalArgumentException(&quot;Bitrate must be greater than 8000.&quot;);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">      else if (bitrate &gt; maxBitrate)</span>
<span class="nc" id="L231">        throw new IllegalArgumentException(&quot;Bitrate must be less than &quot; + maxBitrate);</span>
    }

<span class="nc" id="L234">    this.bitrate = bitrate;</span>
<span class="nc" id="L235">    return this;</span>
  }

  /**
   * Sets the userlimit for the new VoiceChannel
   *
   * @param userlimit The userlimit for the new VoiceChannel or {@code null}/{@code 0} to use no
   *     limit,
   * @throws UnsupportedOperationException If this ChannelAction is not for a VoiceChannel
   * @throws IllegalArgumentException If the provided userlimit is negative or above {@code 99}
   * @return The current ChannelAction, for chaining convenience
   */
  public ChannelAction setUserlimit(Integer userlimit) {
<span class="nc bnc" id="L248" title="All 2 branches missed.">    if (type != ChannelType.VOICE)</span>
<span class="nc" id="L249">      throw new UnsupportedOperationException(&quot;Can only set the userlimit for a VoiceChannel!&quot;);</span>
<span class="nc bnc" id="L250" title="All 6 branches missed.">    if (userlimit != null &amp;&amp; (userlimit &lt; 0 || userlimit &gt; 99))</span>
<span class="nc" id="L251">      throw new IllegalArgumentException(&quot;Userlimit must be between 0-99!&quot;);</span>
<span class="nc" id="L252">    this.userlimit = userlimit;</span>
<span class="nc" id="L253">    return this;</span>
  }

  @Override
  protected RequestBody finalizeData() {
<span class="nc" id="L258">    JSONObject object = new JSONObject();</span>
<span class="nc" id="L259">    object.put(&quot;name&quot;, name);</span>
<span class="nc" id="L260">    object.put(&quot;type&quot;, type.getId());</span>
<span class="nc" id="L261">    object.put(&quot;permission_overwrites&quot;, new JSONArray(overrides));</span>
<span class="nc bnc" id="L262" title="All 3 branches missed.">    switch (type) {</span>
      case VOICE:
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (bitrate != null) object.put(&quot;bitrate&quot;, bitrate.intValue());</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (userlimit != null) object.put(&quot;user_limit&quot;, userlimit.intValue());</span>
        break;
      case TEXT:
<span class="nc bnc" id="L268" title="All 4 branches missed.">        if (topic != null &amp;&amp; !topic.isEmpty()) object.put(&quot;topic&quot;, topic);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (nsfw != null) object.put(&quot;nsfw&quot;, nsfw);</span>
    }
<span class="nc bnc" id="L271" title="All 4 branches missed.">    if (type != ChannelType.CATEGORY &amp;&amp; parent != null) object.put(&quot;parent_id&quot;, parent.getId());</span>

<span class="nc" id="L273">    return getRequestBody(object);</span>
  }

  @Override
  protected void handleResponse(Response response, Request&lt;Channel&gt; request) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">    if (!response.isOk()) {</span>
<span class="nc" id="L279">      request.onFailure(response);</span>
<span class="nc" id="L280">      return;</span>
    }

<span class="nc" id="L283">    EntityBuilder builder = api.getEntityBuilder();</span>
    ;
    Channel channel;
<span class="nc bnc" id="L286" title="All 4 branches missed.">    switch (type) {</span>
      case VOICE:
<span class="nc" id="L288">        channel = builder.createVoiceChannel(response.getObject(), guild.getIdLong());</span>
<span class="nc" id="L289">        break;</span>
      case TEXT:
<span class="nc" id="L291">        channel = builder.createTextChannel(response.getObject(), guild.getIdLong());</span>
<span class="nc" id="L292">        break;</span>
      case CATEGORY:
<span class="nc" id="L294">        channel = builder.createCategory(response.getObject(), guild.getIdLong());</span>
<span class="nc" id="L295">        break;</span>
      default:
<span class="nc" id="L297">        request.onFailure(new IllegalStateException(&quot;Created channel of unknown type!&quot;));</span>
<span class="nc" id="L298">        return;</span>
    }
<span class="nc" id="L300">    request.onSuccess(channel);</span>
<span class="nc" id="L301">  }</span>

  protected void checkPermissions(Permission... permissions) {
<span class="nc bnc" id="L304" title="All 2 branches missed.">    if (permissions == null) return;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">    for (Permission p : permissions) Checks.notNull(p, &quot;Permissions&quot;);</span>
<span class="nc" id="L306">  }</span>

  protected void checkPermissions(Collection&lt;Permission&gt; permissions) {
<span class="nc bnc" id="L309" title="All 2 branches missed.">    if (permissions == null) return;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">    for (Permission p : permissions) Checks.notNull(p, &quot;Permissions&quot;);</span>
<span class="nc" id="L311">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>