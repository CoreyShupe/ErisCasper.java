<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InviteImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ErisCasper.java</a> &gt; <a href="index.source.html" class="el_package">net.dv8tion.jda.core.entities.impl</a> &gt; <span class="el_source">InviteImpl.java</span></div><h1>InviteImpl.java</h1><pre class="source lang-java linenums">/*
 *     Copyright 2015-2018 Austin Keener &amp; Michael Ritter &amp; Florian Spie√ü
 *     Copyright 2018-2018 &quot;Princess&quot; Lana Samson
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.dv8tion.jda.core.entities.impl;

import java.time.OffsetDateTime;
import net.dv8tion.jda.core.JDA;
import net.dv8tion.jda.core.Permission;
import net.dv8tion.jda.core.entities.*;
import net.dv8tion.jda.core.exceptions.InsufficientPermissionException;
import net.dv8tion.jda.core.requests.Request;
import net.dv8tion.jda.core.requests.Response;
import net.dv8tion.jda.core.requests.RestAction;
import net.dv8tion.jda.core.requests.Route;
import net.dv8tion.jda.core.requests.restaction.AuditableRestAction;
import net.dv8tion.jda.core.utils.Checks;
import org.json.JSONArray;
import org.json.JSONObject;

public class InviteImpl implements Invite {
  private final JDAImpl api;
  private final Channel channel;
  private final String code;
  private final boolean expanded;
  private final Guild guild;
  private final User inviter;
  private final int maxAge;
  private final int maxUses;
  private final boolean temporary;
  private final OffsetDateTime timeCreated;
  private final int uses;

  public InviteImpl(
      final JDAImpl api,
      final String code,
      final boolean expanded,
      final User inviter,
      final int maxAge,
      final int maxUses,
      final boolean temporary,
      final OffsetDateTime timeCreated,
      final int uses,
      final Channel channel,
<span class="nc" id="L57">      final Guild guild) {</span>
<span class="nc" id="L58">    this.api = api;</span>
<span class="nc" id="L59">    this.code = code;</span>
<span class="nc" id="L60">    this.expanded = expanded;</span>
<span class="nc" id="L61">    this.inviter = inviter;</span>
<span class="nc" id="L62">    this.maxAge = maxAge;</span>
<span class="nc" id="L63">    this.maxUses = maxUses;</span>
<span class="nc" id="L64">    this.temporary = temporary;</span>
<span class="nc" id="L65">    this.timeCreated = timeCreated;</span>
<span class="nc" id="L66">    this.uses = uses;</span>
<span class="nc" id="L67">    this.channel = channel;</span>
<span class="nc" id="L68">    this.guild = guild;</span>
<span class="nc" id="L69">  }</span>

  public static RestAction&lt;Invite&gt; resolve(final JDA api, final String code) {
<span class="nc" id="L72">    Checks.notNull(code, &quot;code&quot;);</span>
<span class="nc" id="L73">    Checks.notNull(api, &quot;api&quot;);</span>

<span class="nc" id="L75">    final Route.CompiledRoute route = Route.Invites.GET_INVITE.compile(code);</span>

<span class="nc" id="L77">    return new RestAction&lt;Invite&gt;(api, route) {</span>
      @Override
      protected void handleResponse(final Response response, final Request&lt;Invite&gt; request) {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (response.isOk()) {</span>
<span class="nc" id="L81">          final Invite invite = this.api.getEntityBuilder().createInvite(response.getObject());</span>
<span class="nc" id="L82">          request.onSuccess(invite);</span>
<span class="nc" id="L83">        } else {</span>
<span class="nc" id="L84">          request.onFailure(response);</span>
        }
<span class="nc" id="L86">      }</span>
    };
  }

  @Override
  public AuditableRestAction&lt;Void&gt; delete() {
<span class="nc" id="L92">    final Route.CompiledRoute route = Route.Invites.DELETE_INVITE.compile(this.code);</span>

<span class="nc" id="L94">    return new AuditableRestAction&lt;Void&gt;(this.api, route) {</span>
      @Override
      protected void handleResponse(final Response response, final Request&lt;Void&gt; request) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (response.isOk()) request.onSuccess(null);</span>
<span class="nc" id="L98">        else request.onFailure(response);</span>
<span class="nc" id="L99">      }</span>
    };
  }

  @Override
  public RestAction&lt;Invite&gt; expand() {
<span class="nc bnc" id="L105" title="All 2 branches missed.">    if (this.expanded) return new RestAction.EmptyRestAction&lt;&gt;(getJDA(), this);</span>

<span class="nc" id="L107">    final net.dv8tion.jda.core.entities.Guild guild = this.api.getGuildById(this.guild.getIdLong());</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">    if (guild == null)</span>
<span class="nc" id="L110">      throw new UnsupportedOperationException(&quot;You're not in the guild this invite points to&quot;);</span>

<span class="nc" id="L112">    final Member member = guild.getSelfMember();</span>

    Route.CompiledRoute route;

<span class="nc" id="L116">    final net.dv8tion.jda.core.entities.Channel channel =</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        this.channel.getType() == ChannelType.TEXT</span>
<span class="nc" id="L118">            ? guild.getTextChannelById(this.channel.getIdLong())</span>
<span class="nc" id="L119">            : guild.getVoiceChannelById(this.channel.getIdLong());</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">    if (member.hasPermission(channel, Permission.MANAGE_CHANNEL)) {</span>
<span class="nc" id="L122">      route = Route.Invites.GET_CHANNEL_INVITES.compile(channel.getId());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    } else if (member.hasPermission(Permission.MANAGE_SERVER)) {</span>
<span class="nc" id="L124">      route = Route.Invites.GET_GUILD_INVITES.compile(guild.getId());</span>
    } else {
<span class="nc" id="L126">      throw new InsufficientPermissionException(</span>
          Permission.MANAGE_CHANNEL, &quot;You don't have the permission to view the full invite info&quot;);
    }

<span class="nc" id="L130">    return new RestAction&lt;Invite&gt;(this.api, route) {</span>
      @Override
      protected void handleResponse(final Response response, final Request&lt;Invite&gt; request) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (response.isOk()) {</span>
<span class="nc" id="L134">          final EntityBuilder entityBuilder = this.api.getEntityBuilder();</span>
<span class="nc" id="L135">          final JSONArray array = response.getArray();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">          for (int i = 0; i &lt; array.length(); i++) {</span>
<span class="nc" id="L137">            final JSONObject object = array.getJSONObject(i);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (InviteImpl.this.code.equals(object.getString(&quot;code&quot;))) {</span>
<span class="nc" id="L139">              request.onSuccess(entityBuilder.createInvite(object));</span>
<span class="nc" id="L140">              return;</span>
            }
          }
<span class="nc" id="L143">          request.onFailure(</span>
              new IllegalStateException(&quot;Missing the invite in the channel/guild invite list&quot;));
<span class="nc" id="L145">        } else {</span>
<span class="nc" id="L146">          request.onFailure(response);</span>
        }
<span class="nc" id="L148">      }</span>
    };
  }

  @Override
  public Channel getChannel() {
<span class="nc" id="L154">    return this.channel;</span>
  }

  @Override
  public String getCode() {
<span class="nc" id="L159">    return this.code;</span>
  }

  @Override
  public OffsetDateTime getCreationTime() {
<span class="nc bnc" id="L164" title="All 2 branches missed.">    if (!this.expanded) throw new IllegalStateException(&quot;Only valid for expanded invites&quot;);</span>
<span class="nc" id="L165">    return this.timeCreated;</span>
  }

  @Override
  public Guild getGuild() {
<span class="nc" id="L170">    return this.guild;</span>
  }

  @Override
  public User getInviter() {
<span class="nc" id="L175">    return this.inviter;</span>
  }

  @Override
  public JDAImpl getJDA() {
<span class="nc" id="L180">    return this.api;</span>
  }

  @Override
  public int getMaxAge() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">    if (!this.expanded) throw new IllegalStateException(&quot;Only valid for expanded invites&quot;);</span>
<span class="nc" id="L186">    return this.maxAge;</span>
  }

  @Override
  public int getMaxUses() {
<span class="nc bnc" id="L191" title="All 2 branches missed.">    if (!this.expanded) throw new IllegalStateException(&quot;Only valid for expanded invites&quot;);</span>
<span class="nc" id="L192">    return this.maxUses;</span>
  }

  @Override
  public int getUses() {
<span class="nc bnc" id="L197" title="All 2 branches missed.">    if (!this.expanded) throw new IllegalStateException(&quot;Only valid for expanded invites&quot;);</span>
<span class="nc" id="L198">    return this.uses;</span>
  }

  @Override
  public boolean isExpanded() {
<span class="nc" id="L203">    return this.expanded;</span>
  }

  @Override
  public boolean isTemporary() {
<span class="nc bnc" id="L208" title="All 2 branches missed.">    if (!this.expanded) throw new IllegalStateException(&quot;Only valid for expanded invites&quot;);</span>
<span class="nc" id="L209">    return this.temporary;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L214">    return &quot;Invite(&quot; + this.code + &quot;)&quot;;</span>
  }

  public static class ChannelImpl implements Channel {
    private final long id;
    private final String name;
    private final ChannelType type;

<span class="nc" id="L222">    public ChannelImpl(final long id, final String name, final ChannelType type) {</span>
<span class="nc" id="L223">      this.id = id;</span>
<span class="nc" id="L224">      this.name = name;</span>
<span class="nc" id="L225">      this.type = type;</span>
<span class="nc" id="L226">    }</span>

    @Override
    public long getIdLong() {
<span class="nc" id="L230">      return id;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L235">      return this.name;</span>
    }

    @Override
    public ChannelType getType() {
<span class="nc" id="L240">      return this.type;</span>
    }
  }

  public static class GuildImpl implements Guild {

    private final String iconId, name, splashId;
    private final long id;

<span class="nc" id="L249">    public GuildImpl(final long id, final String iconId, final String name, final String splashId) {</span>
<span class="nc" id="L250">      this.id = id;</span>
<span class="nc" id="L251">      this.iconId = iconId;</span>
<span class="nc" id="L252">      this.name = name;</span>
<span class="nc" id="L253">      this.splashId = splashId;</span>
<span class="nc" id="L254">    }</span>

    @Override
    public String getIconId() {
<span class="nc" id="L258">      return this.iconId;</span>
    }

    @Override
    public String getIconUrl() {
<span class="nc bnc" id="L263" title="All 2 branches missed.">      return this.iconId == null</span>
          ? null
          : &quot;https://cdn.discordapp.com/icons/&quot; + this.id + &quot;/&quot; + this.iconId + &quot;.jpg&quot;;
    }

    @Override
    public long getIdLong() {
<span class="nc" id="L270">      return id;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L275">      return this.name;</span>
    }

    @Override
    public String getSplashId() {
<span class="nc" id="L280">      return this.splashId;</span>
    }

    @Override
    public String getSplashUrl() {
<span class="nc bnc" id="L285" title="All 2 branches missed.">      return this.splashId == null</span>
          ? null
          : &quot;https://cdn.discordapp.com/splashes/&quot; + this.id + &quot;/&quot; + this.splashId + &quot;.jpg&quot;;
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>