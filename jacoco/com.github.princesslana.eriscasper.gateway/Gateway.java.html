<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Gateway.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ErisCasper.java</a> &gt; <a href="index.source.html" class="el_package">com.github.princesslana.eriscasper.gateway</a> &gt; <span class="el_source">Gateway.java</span></div><h1>Gateway.java</h1><pre class="source lang-java linenums">package com.github.princesslana.eriscasper.gateway;

import com.github.princesslana.eriscasper.BotToken;
import com.github.princesslana.eriscasper.data.event.Event;
import com.github.princesslana.eriscasper.data.event.HelloEventData;
import com.github.princesslana.eriscasper.data.event.ReadyEvent;
import com.github.princesslana.eriscasper.rx.Singles;
import com.github.princesslana.eriscasper.rx.websocket.RxWebSocket;
import com.github.princesslana.eriscasper.rx.websocket.RxWebSocketEvent;
import com.google.common.base.Preconditions;
import io.github.resilience4j.ratelimiter.RateLimiter;
import io.github.resilience4j.ratelimiter.RateLimiterConfig;
import io.github.resilience4j.ratelimiter.operator.RateLimiterOperator;
import io.reactivex.Completable;
import io.reactivex.Observable;
import io.reactivex.Single;
import java.time.Duration;
import java.util.Optional;
import java.util.concurrent.TimeUnit;
import okhttp3.OkHttpClient;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class Gateway {

<span class="fc" id="L26">  private static final Logger LOG = LoggerFactory.getLogger(Gateway.class);</span>

  /**
   * @see &lt;a href=&quot;https://discordapp.com/developers/docs/topics/gateway#sending-payloads&quot;&gt;
   *     https://discordapp.com/developers/docs/topics/gateway#sending-payloads&lt;/a&gt;
   */
  private static final int MAX_MESSAGE_SIZE = 4096;

  private static final String VERSION = &quot;6&quot;;
  private static final String ENCODING = &quot;json&quot;;

  private final RxWebSocket ws;
  private final Payloads payloads;

<span class="fc" id="L40">  private Optional&lt;SequenceNumber&gt; lastSeenSequenceNumber = Optional.empty();</span>

<span class="fc" id="L42">  private Optional&lt;SessionId&gt; sessionId = Optional.empty();</span>

  /**
   * @see &lt;a href=&quot;https://discordapp.com/developers/docs/topics/gateway#rate-limiting&quot;&gt;
   *     https://discordapp.com/developers/docs/topics/gateway#rate-limiting&lt;/a&gt;
   */
<span class="fc" id="L48">  private final RateLimiter sendLimit =</span>
<span class="fc" id="L49">      RateLimiter.of(</span>
          &quot;Gateway#sendLimit&quot;,
<span class="fc" id="L51">          RateLimiterConfig.custom()</span>
<span class="fc" id="L52">              .limitRefreshPeriod(Duration.ofSeconds(60))</span>
<span class="fc" id="L53">              .limitForPeriod(120)</span>
<span class="fc" id="L54">              .timeoutDuration(Duration.ofSeconds(60))</span>
<span class="fc" id="L55">              .build());</span>

  /**
   * @see &lt;a href=&quot;https://discordapp.com/developers/docs/topics/gateway#identifying&quot;&gt;
   *     https://discordapp.com/developers/docs/topics/gateway#identifying&lt;/a&gt;
   */
<span class="fc" id="L61">  private final RateLimiter identifyLimit =</span>
<span class="fc" id="L62">      RateLimiter.of(</span>
          &quot;Gateway#identifyLimit&quot;,
<span class="fc" id="L64">          RateLimiterConfig.custom()</span>
<span class="fc" id="L65">              .limitRefreshPeriod(Duration.ofSeconds(5))</span>
<span class="fc" id="L66">              .limitForPeriod(1)</span>
<span class="fc" id="L67">              .timeoutDuration(Duration.ofSeconds(60))</span>
<span class="fc" id="L68">              .build());</span>

<span class="fc" id="L70">  public Gateway(RxWebSocket ws, Payloads payloads) {</span>
<span class="fc" id="L71">    this.ws = ws;</span>
<span class="fc" id="L72">    this.payloads = payloads;</span>
<span class="fc" id="L73">  }</span>

  private boolean isResumable() {
<span class="pc bpc" id="L76" title="3 of 4 branches missed.">    return sessionId.isPresent() &amp;&amp; lastSeenSequenceNumber.isPresent();</span>
  }

  private void setSessionId(SessionId sid) {
<span class="fc" id="L80">    this.sessionId = Optional.of(sid);</span>
<span class="fc" id="L81">  }</span>

  private void sequenceNumberSeen(Optional&lt;SequenceNumber&gt; seq) {
<span class="pc" id="L84">    seq.ifPresent(sid -&gt; lastSeenSequenceNumber = Optional.of(sid));</span>
<span class="fc" id="L85">  }</span>

  @SuppressWarnings(&quot;unchecked&quot;)
  public Observable&lt;Event&gt; connect(String url, BotToken token) {
<span class="fc" id="L89">    Observable&lt;Payload&gt; ps =</span>
<span class="fc" id="L90">        ws.connect(String.format(&quot;%s?v=%s&amp;encoding=%s&quot;, url, VERSION, ENCODING))</span>
<span class="fc" id="L91">            .ofType(RxWebSocketEvent.StringMessage.class)</span>
<span class="fc" id="L92">            .map(RxWebSocketEvent.StringMessage::getText)</span>
<span class="fc" id="L93">            .flatMapMaybe(</span>
<span class="fc" id="L94">                Singles.toMaybeAnd(</span>
<span class="fc" id="L95">                    payloads::read, (s, t) -&gt; LOG.warn(&quot;Error reading payload: {}&quot;, s, t)))</span>
<span class="fc" id="L96">            .doOnNext(p -&gt; sequenceNumberSeen(p.s()))</span>
<span class="fc" id="L97">            .share();</span>

<span class="fc" id="L99">    Completable heartbeat =</span>
<span class="fc" id="L100">        ps.filter(Payload.isOp(OpCode.HELLO)).flatMapCompletable(p -&gt; heartbeat(ws, p));</span>

<span class="fc" id="L102">    Completable identify =</span>
<span class="fc" id="L103">        ps.filter(Payload.isOp(OpCode.HELLO))</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            .flatMapCompletable(p -&gt; isResumable() ? resume(ws, token) : identify(ws, token));</span>

<span class="fc" id="L106">    Observable&lt;Event&gt; events = ps.flatMapMaybe(payloads::toEvent).share();</span>

<span class="fc" id="L108">    Completable setSessionId =</span>
        events
<span class="fc" id="L110">            .ofType(ReadyEvent.class)</span>
<span class="fc" id="L111">            .map(r -&gt; r.unwrap().getSessionId())</span>
<span class="fc" id="L112">            .doOnNext(s -&gt; setSessionId(SessionId.of(s)))</span>
<span class="fc" id="L113">            .ignoreElements();</span>

<span class="fc" id="L115">    return Observable.mergeArray(</span>
<span class="fc" id="L116">            events, setSessionId.toObservable(), heartbeat.toObservable(), identify.toObservable())</span>
<span class="fc" id="L117">        .doOnNext(e -&gt; LOG.debug(&quot;Event: {}.&quot;, e));</span>
  }

  private Completable send(RxWebSocket ws, Payload payload) {
<span class="fc" id="L121">    return payloads</span>
<span class="fc" id="L122">        .writeToString(payload)</span>
<span class="fc" id="L123">        .lift(RateLimiterOperator.of(sendLimit))</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        .filter(s -&gt; s.getBytes().length &lt;= MAX_MESSAGE_SIZE)</span>
<span class="pc" id="L125">        .doOnComplete(() -&gt; LOG.warn(&quot;Payload rejected as too long: {}.&quot;, payload))</span>
<span class="fc" id="L126">        .flatMapCompletable(ws::send)</span>
<span class="fc" id="L127">        .doOnComplete(() -&gt; LOG.debug(&quot;Sent: {}.&quot;, payload));</span>
  }

  private Completable identify(RxWebSocket ws, BotToken token) {
<span class="fc" id="L131">    return Single.just(payloads.identify(token))</span>
<span class="fc" id="L132">        .lift(RateLimiterOperator.of(identifyLimit))</span>
<span class="fc" id="L133">        .flatMapCompletable(p -&gt; send(ws, p));</span>
  }

  private Completable heartbeat(RxWebSocket ws, Payload hello) {
<span class="fc" id="L137">    return payloads</span>
<span class="fc" id="L138">        .dataAs(hello, HelloEventData.class)</span>
<span class="fc" id="L139">        .flatMapObservable(</span>
<span class="fc" id="L140">            h -&gt; Observable.interval(h.getHeartbeatInterval(), TimeUnit.MILLISECONDS))</span>
<span class="pc" id="L141">        .flatMapCompletable(l -&gt; send(ws, payloads.heartbeat(lastSeenSequenceNumber)));</span>
  }

  private Completable resume(RxWebSocket ws, BotToken token) {
<span class="nc" id="L145">    Preconditions.checkState(sessionId.isPresent(), &quot;Can not resume without a session id&quot;);</span>
<span class="nc" id="L146">    Preconditions.checkState(</span>
<span class="nc" id="L147">        lastSeenSequenceNumber.isPresent(), &quot;Can not resume without a sequence number&quot;);</span>

<span class="nc" id="L149">    return Single.just(</span>
<span class="nc" id="L150">            ImmutableResume.builder()</span>
<span class="nc" id="L151">                .token(token)</span>
<span class="nc" id="L152">                .sessionId(sessionId.get())</span>
<span class="nc" id="L153">                .seq(lastSeenSequenceNumber.get())</span>
<span class="nc" id="L154">                .build())</span>
<span class="nc" id="L155">        .map(payloads::resume)</span>
<span class="nc" id="L156">        .flatMapCompletable(p -&gt; send(ws, p));</span>
  }

  public static Gateway create(OkHttpClient client, Payloads payloads) {
<span class="nc" id="L160">    return new Gateway(new RxWebSocket(client), payloads);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>