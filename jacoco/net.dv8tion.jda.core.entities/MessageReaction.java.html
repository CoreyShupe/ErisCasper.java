<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageReaction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ErisCasper.java</a> &gt; <a href="index.source.html" class="el_package">net.dv8tion.jda.core.entities</a> &gt; <span class="el_source">MessageReaction.java</span></div><h1>MessageReaction.java</h1><pre class="source lang-java linenums">/*
 *     Copyright 2015-2018 Austin Keener &amp; Michael Ritter &amp; Florian Spieß
 *     Copyright 2018-2018 &quot;Princess&quot; Lana Samson
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.dv8tion.jda.core.entities;

import java.util.Objects;
import net.dv8tion.jda.client.entities.Group;
import net.dv8tion.jda.core.JDA;
import net.dv8tion.jda.core.Permission;
import net.dv8tion.jda.core.exceptions.InsufficientPermissionException;
import net.dv8tion.jda.core.exceptions.PermissionException;
import net.dv8tion.jda.core.requests.Request;
import net.dv8tion.jda.core.requests.Response;
import net.dv8tion.jda.core.requests.RestAction;
import net.dv8tion.jda.core.requests.Route;
import net.dv8tion.jda.core.requests.restaction.pagination.ReactionPaginationAction;
import net.dv8tion.jda.core.utils.MiscUtil;

/**
 * An object representing a single MessageReaction from Discord. This is an immutable object and is
 * not updated by method calls or changes in Discord. A new snapshot instance built from Discord is
 * needed to see changes.
 *
 * @since 3.0
 * @author Florian Spieß
 */
public class MessageReaction {

  private final MessageChannel channel;
  private final ReactionEmote emote;
  private final long messageId;
  private final boolean self;
  private final int count;

  /**
   * Creates a new MessageReaction instance
   *
   * @param channel The {@link net.dv8tion.jda.core.entities.MessageChannel} this Reaction was used
   *     in
   * @param emote The {@link net.dv8tion.jda.core.entities.MessageReaction.ReactionEmote
   *     ReactionEmote} that was used
   * @param messageId The message id this reaction is attached to
   * @param self Whether we already reacted with this Reaction
   * @param count The amount of people that reacted with this Reaction
   */
  public MessageReaction(
<span class="nc" id="L60">      MessageChannel channel, ReactionEmote emote, long messageId, boolean self, int count) {</span>
<span class="nc" id="L61">    this.channel = channel;</span>
<span class="nc" id="L62">    this.emote = emote;</span>
<span class="nc" id="L63">    this.messageId = messageId;</span>
<span class="nc" id="L64">    this.self = self;</span>
<span class="nc" id="L65">    this.count = count;</span>
<span class="nc" id="L66">  }</span>

  /**
   * The JDA instance of this Reaction
   *
   * @return The JDA instance of this Reaction
   */
  public JDA getJDA() {
<span class="nc" id="L74">    return channel.getJDA();</span>
  }

  /**
   * Whether the currently logged in account has reacted with this reaction
   *
   * @return True, if we reacted with this reaction
   */
  public boolean isSelf() {
<span class="nc" id="L83">    return self;</span>
  }

  /**
   * The amount of users that already reacted with this Reaction &lt;br&gt;
   * &lt;b&gt;This is not updated, it is a {@code final int} per Reaction instance&lt;/b&gt;
   *
   * &lt;p&gt;This value is not available in events such as {@link
   * net.dv8tion.jda.core.events.message.react.MessageReactionAddEvent MessageReactionAddEvent} and
   * {@link net.dv8tion.jda.core.events.message.react.MessageReactionRemoveEvent
   * MessageReactionRemoveEvent} in which case an {@link java.lang.IllegalStateException
   * IllegalStateException} is thrown!
   *
   * @throws java.lang.IllegalStateException If this MessageReaction is from an event which does not
   *     provide a count
   * @return The amount of users that reacted with this Reaction
   */
  public int getCount() {
<span class="nc bnc" id="L101" title="All 2 branches missed.">    if (count &lt; 0)</span>
<span class="nc" id="L102">      throw new IllegalStateException(&quot;Cannot retrieve count for this MessageReaction!&quot;);</span>
<span class="nc" id="L103">    return count;</span>
  }

  /**
   * The {@link net.dv8tion.jda.core.entities.ChannelType ChannelType} this Reaction was used in.
   *
   * @return The ChannelType
   */
  public ChannelType getChannelType() {
<span class="nc" id="L112">    return channel.getType();</span>
  }

  /**
   * Whether this Reaction was used in a {@link net.dv8tion.jda.core.entities.MessageChannel
   * MessageChannel} of the specified {@link net.dv8tion.jda.core.entities.ChannelType ChannelType}.
   *
   * @param type The ChannelType to compare
   * @return True, if this Reaction was used in a MessageChannel from the specified ChannelType
   */
  public boolean isFromType(ChannelType type) {
<span class="nc bnc" id="L123" title="All 2 branches missed.">    return getChannelType() == type;</span>
  }

  /**
   * The {@link net.dv8tion.jda.core.entities.Guild Guild} this Reaction was used in, this might
   * return {@code null} when this Reaction was not used in a MessageChannel from the ChannelType
   * {@link net.dv8tion.jda.core.entities.ChannelType#TEXT TEXT}!
   *
   * @return {@link net.dv8tion.jda.core.entities.Guild Guild} this Reaction was used in, or {@code
   *     null}
   */
  public Guild getGuild() {
<span class="nc" id="L135">    TextChannel channel = getTextChannel();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">    return channel != null ? channel.getGuild() : null;</span>
  }

  /**
   * The {@link net.dv8tion.jda.core.entities.TextChannel TextChannel} this Reaction was used in or
   * {@code null} if this is not from type {@link net.dv8tion.jda.core.entities.ChannelType#TEXT
   * ChannelType.TEXT}!
   *
   * @return The {@link net.dv8tion.jda.core.entities.TextChannel TextChannel} or {@code null}
   */
  public TextChannel getTextChannel() {
<span class="nc bnc" id="L147" title="All 2 branches missed.">    return getChannel() instanceof TextChannel ? (TextChannel) getChannel() : null;</span>
  }

  /**
   * The {@link net.dv8tion.jda.core.entities.PrivateChannel PrivateChannel} this Reaction was used
   * in or {@code null} if this is not from type {@link
   * net.dv8tion.jda.core.entities.ChannelType#PRIVATE ChannelType.PRIVATE}!
   *
   * @return The {@link net.dv8tion.jda.core.entities.PrivateChannel PrivateChannel} or {@code null}
   */
  public PrivateChannel getPrivateChannel() {
<span class="nc bnc" id="L158" title="All 2 branches missed.">    return getChannel() instanceof PrivateChannel ? (PrivateChannel) getChannel() : null;</span>
  }

  /**
   * The {@link net.dv8tion.jda.client.entities.Group Group} this Reaction was used in or {@code
   * null} if this is not from type {@link net.dv8tion.jda.core.entities.ChannelType#GROUP
   * ChannelType.GROUP}!
   *
   * @return The {@link net.dv8tion.jda.client.entities.Group Group} or {@code null}
   */
  public Group getGroup() {
<span class="nc bnc" id="L169" title="All 2 branches missed.">    return getChannel() instanceof Group ? (Group) getChannel() : null;</span>
  }

  /**
   * The {@link net.dv8tion.jda.core.entities.MessageChannel MessageChannel} this Reaction was used
   * in.
   *
   * @return The channel this Reaction was used in
   */
  public MessageChannel getChannel() {
<span class="nc" id="L179">    return channel;</span>
  }

  /**
   * The {@link net.dv8tion.jda.core.entities.MessageReaction.ReactionEmote ReactionEmote} of this
   * Reaction
   *
   * @return The final instance of this Reaction's Emote/Emoji
   */
  public ReactionEmote getReactionEmote() {
<span class="nc" id="L189">    return emote;</span>
  }

  /**
   * The message id this reaction is attached to
   *
   * @return The message id this reaction is attached to
   */
  public String getMessageId() {
<span class="nc" id="L198">    return Long.toUnsignedString(messageId);</span>
  }

  /**
   * The message id this reaction is attached to
   *
   * @return The message id this reaction is attached to
   */
  public long getMessageIdLong() {
<span class="nc" id="L207">    return messageId;</span>
  }

  /**
   * Retrieves the {@link net.dv8tion.jda.core.entities.User Users} that already reacted with this
   * MessageReaction. &lt;br&gt;
   * This is an overload of {@link #getUsers(int)} with {@code 100}.
   *
   * &lt;p&gt;Possible ErrorResponses include:
   *
   * &lt;ul&gt;
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_MESSAGE UNKNOWN_MESSAGE} &lt;br&gt;
   *       If the message this reaction was attached to got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_CHANNEL UNKNOWN_CHANNEL} &lt;br&gt;
   *       If the channel this reaction was used in got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#MISSING_ACCESS MISSING_ACCESS} &lt;br&gt;
   *       If we were removed from the channel/guild
   * &lt;/ul&gt;
   *
   * @return {@link net.dv8tion.jda.core.requests.restaction.pagination.ReactionPaginationAction
   *     ReactionPaginationAction} &lt;br&gt;
   *     Retrieves an immutable list of users that reacted with this Reaction.
   */
  public ReactionPaginationAction getUsers() {
<span class="nc" id="L231">    return getUsers(100);</span>
  }

  /**
   * Retrieves the {@link net.dv8tion.jda.core.entities.User Users} that already reacted with this
   * MessageReaction. The maximum amount of users that can be retrieved is 100.
   *
   * &lt;p&gt;Possible ErrorResponses include:
   *
   * &lt;ul&gt;
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_MESSAGE UNKNOWN_MESSAGE} &lt;br&gt;
   *       If the message this reaction was attached to got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_CHANNEL UNKNOWN_CHANNEL} &lt;br&gt;
   *       If the channel this reaction was used in got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#MISSING_ACCESS MISSING_ACCESS} &lt;br&gt;
   *       If we were removed from the channel/guild
   * &lt;/ul&gt;
   *
   * @param amount the amount of users to retrieve
   * @throws IllegalArgumentException if the provided amount is not between 1-100
   * @return {@link net.dv8tion.jda.core.requests.restaction.pagination.ReactionPaginationAction
   *     ReactionPaginationAction} &lt;br&gt;
   *     Retrieves an immutable list of users that reacted with this Reaction.
   */
  public ReactionPaginationAction getUsers(int amount) {
<span class="nc" id="L256">    return new ReactionPaginationAction(this).limit(amount);</span>
  }

  /**
   * Removes this Reaction from the Message. &lt;br&gt;
   * This will remove our own reaction as an overload of {@link #removeReaction(User)}.
   *
   * &lt;p&gt;Possible ErrorResponses include:
   *
   * &lt;ul&gt;
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_MESSAGE UNKNOWN_MESSAGE} &lt;br&gt;
   *       If the message this reaction was attached to got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_CHANNEL UNKNOWN_CHANNEL} &lt;br&gt;
   *       If the channel this reaction was used in got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#MISSING_ACCESS MISSING_ACCESS} &lt;br&gt;
   *       If we were removed from the channel/guild
   * &lt;/ul&gt;
   *
   * @return {@link net.dv8tion.jda.core.requests.RestAction RestAction} - Type: Void Nothing is
   *     returned on success
   */
  public RestAction&lt;Void&gt; removeReaction() {
<span class="nc" id="L278">    return removeReaction(getJDA().getSelfUser());</span>
  }

  /**
   * Removes this Reaction from the Message. &lt;br&gt;
   * This will remove the reaction of the {@link net.dv8tion.jda.core.entities.User User} provided.
   *
   * &lt;p&gt;If the provided User did not react with this Reaction this does nothing.
   *
   * &lt;p&gt;Possible ErrorResponses include:
   *
   * &lt;ul&gt;
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_MESSAGE UNKNOWN_MESSAGE} &lt;br&gt;
   *       If the message this reaction was attached to got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#UNKNOWN_CHANNEL UNKNOWN_CHANNEL} &lt;br&gt;
   *       If the channel this reaction was used in got deleted.
   *   &lt;li&gt;{@link net.dv8tion.jda.core.requests.ErrorResponse#MISSING_ACCESS MISSING_ACCESS} &lt;br&gt;
   *       If we were removed from the channel/guild
   * &lt;/ul&gt;
   *
   * @param user The User of which to remove the reaction
   * @throws java.lang.IllegalArgumentException If the provided {@code user} is null.
   * @throws net.dv8tion.jda.core.exceptions.InsufficientPermissionException if the provided User is
   *     not us and we do not have permission to {@link
   *     net.dv8tion.jda.core.Permission#MESSAGE_MANAGE manage messages} in the channel this
   *     reaction was used in
   * @return {@link net.dv8tion.jda.core.requests.RestAction RestAction} - Type: Void Nothing is
   *     returned on success
   */
  public RestAction&lt;Void&gt; removeReaction(User user) {
<span class="nc bnc" id="L308" title="All 2 branches missed.">    if (user == null) throw new IllegalArgumentException(&quot;Provided User was null!&quot;);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">    if (!user.equals(getJDA().getSelfUser())) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">      if (channel.getType() == ChannelType.TEXT) {</span>
<span class="nc" id="L311">        Channel channel = (Channel) this.channel;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        if (!channel.getGuild().getSelfMember().hasPermission(channel, Permission.MESSAGE_MANAGE))</span>
<span class="nc" id="L313">          throw new InsufficientPermissionException(Permission.MESSAGE_MANAGE);</span>
<span class="nc" id="L314">      } else {</span>
<span class="nc" id="L315">        throw new PermissionException(</span>
            &quot;Unable to remove Reaction of other user in non-text channel!&quot;);
      }
    }

<span class="nc" id="L320">    String code =</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        emote.isEmote()</span>
<span class="nc" id="L322">            ? emote.getName() + &quot;:&quot; + emote.getId()</span>
<span class="nc" id="L323">            : MiscUtil.encodeUTF8(emote.getName());</span>
    Route.CompiledRoute route;
<span class="nc bnc" id="L325" title="All 2 branches missed.">    if (user.equals(getJDA().getSelfUser()))</span>
<span class="nc" id="L326">      route = Route.Messages.REMOVE_OWN_REACTION.compile(channel.getId(), getMessageId(), code);</span>
    else
<span class="nc" id="L328">      route =</span>
<span class="nc" id="L329">          Route.Messages.REMOVE_REACTION.compile(</span>
<span class="nc" id="L330">              channel.getId(), getMessageId(), code, user.getId());</span>
<span class="nc" id="L331">    return new RestAction&lt;Void&gt;(getJDA(), route) {</span>
      @Override
      protected void handleResponse(Response response, Request&lt;Void&gt; request) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (response.isOk()) request.onSuccess(null);</span>
<span class="nc" id="L335">        else request.onFailure(response);</span>
<span class="nc" id="L336">      }</span>
    };
  }

  @Override
  public boolean equals(Object obj) {
<span class="nc bnc" id="L342" title="All 2 branches missed.">    if (obj == this) return true;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">    if (!(obj instanceof MessageReaction)) return false;</span>
<span class="nc" id="L344">    MessageReaction r = (MessageReaction) obj;</span>
<span class="nc bnc" id="L345" title="All 6 branches missed.">    return r.emote.equals(emote) &amp;&amp; r.self == self &amp;&amp; r.messageId == messageId;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L350">    return &quot;MR:(M:(&quot; + messageId + &quot;) / &quot; + emote + &quot;)&quot;;</span>
  }

  /**
   * Represents an Emoji/Emote of a MessageReaction &lt;br&gt;
   * This is used to wrap both emojis and emotes
   */
  public static class ReactionEmote implements ISnowflake {

    private final JDA api;
    private final String name;
    private final Long id;
<span class="nc" id="L362">    private Emote emote = null;</span>

<span class="nc" id="L364">    public ReactionEmote(String name, Long id, JDA api) {</span>
<span class="nc" id="L365">      this.name = name;</span>
<span class="nc" id="L366">      this.id = id;</span>
<span class="nc" id="L367">      this.api = api;</span>
<span class="nc" id="L368">    }</span>

    public ReactionEmote(Emote emote) {
<span class="nc" id="L371">      this(emote.getName(), emote.getIdLong(), emote.getJDA());</span>
<span class="nc" id="L372">      this.emote = emote;</span>
<span class="nc" id="L373">    }</span>

    /**
     * Whether this is an {@link net.dv8tion.jda.core.entities.Emote Emote} wrapper.
     *
     * @return True, if {@link #getId()} is not null
     */
    public boolean isEmote() {
<span class="nc bnc" id="L381" title="All 2 branches missed.">      return emote != null;</span>
    }

    @Override
    public String getId() {
<span class="nc bnc" id="L386" title="All 2 branches missed.">      return id != null ? String.valueOf(id) : null;</span>
    }

    @Override
    public long getIdLong() {
<span class="nc bnc" id="L391" title="All 2 branches missed.">      if (id == null) throw new IllegalStateException(&quot;No id available&quot;);</span>
<span class="nc" id="L392">      return id;</span>
    }

    /**
     * The name for this emote/emoji &lt;br&gt;
     * For unicode emojis this will be the unicode of said emoji.
     *
     * @return The name for this emote/emoji
     */
    public String getName() {
<span class="nc" id="L402">      return name;</span>
    }

    /**
     * The instance of {@link net.dv8tion.jda.core.entities.Emote Emote} for the Reaction instance.
     * &lt;br&gt;
     * Might be null if {@link #getId()} returns null.
     *
     * @return The possibly-null Emote for the Reaction instance
     */
    public Emote getEmote() {
<span class="nc" id="L413">      return emote;</span>
    }

    /**
     * The current JDA instance for the Reaction
     *
     * @return The JDA instance of the Reaction
     */
    public JDA getJDA() {
<span class="nc" id="L422">      return api;</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L427" title="All 2 branches missed.">      return obj instanceof ReactionEmote</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">          &amp;&amp; Objects.equals(((ReactionEmote) obj).id, id)</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">          &amp;&amp; ((ReactionEmote) obj).getName().equals(name);</span>
    }

    @Override
    public String toString() {
<span class="nc bnc" id="L434" title="All 2 branches missed.">      return &quot;RE:&quot; + (isEmote() ? getEmote() : getName() + &quot;(&quot; + id + &quot;)&quot;);</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>