<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationManagerUpdatable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ErisCasper.java</a> &gt; <a href="index.source.html" class="el_package">net.dv8tion.jda.client.managers</a> &gt; <span class="el_source">ApplicationManagerUpdatable.java</span></div><h1>ApplicationManagerUpdatable.java</h1><pre class="source lang-java linenums">/*
 *     Copyright 2015-2018 Austin Keener &amp; Michael Ritter &amp; Florian Spie√ü
 *     Copyright 2018-2018 &quot;Princess&quot; Lana Samson
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.dv8tion.jda.client.managers;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.regex.Pattern;
import net.dv8tion.jda.client.entities.Application;
import net.dv8tion.jda.client.entities.impl.ApplicationImpl;
import net.dv8tion.jda.client.managers.fields.ApplicationField;
import net.dv8tion.jda.core.JDA;
import net.dv8tion.jda.core.entities.Icon;
import net.dv8tion.jda.core.requests.Request;
import net.dv8tion.jda.core.requests.Response;
import net.dv8tion.jda.core.requests.RestAction;
import net.dv8tion.jda.core.requests.Route;
import net.dv8tion.jda.core.utils.Checks;
import org.json.JSONObject;

/**
 * An {@link #update() updatable} manager that allows to modify role settings like the {@link
 * #getNameField() name} and the {@link #getIconField() icon}.
 *
 * &lt;p&gt;This manager allows to modify multiple fields at once by getting the {@link
 * net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for specific properties
 * and setting or resetting their values; followed by a call of {@link #update()}!
 *
 * &lt;p&gt;The {@link net.dv8tion.jda.client.managers.ApplicationManager ApplicationManager}
 * implementation simplifies this process by giving simple setters that return the {@link #update()
 * update} {@link net.dv8tion.jda.core.requests.RestAction RestAction}
 *
 * @since 3.0
 * @author Aljoscha Grebe
 */
public class ApplicationManagerUpdatable {
<span class="nc" id="L51">  public static final Pattern URL_PATTERN =</span>
<span class="nc" id="L52">      Pattern.compile(&quot;\\s*https?://.+\\..{2,}\\s*&quot;, Pattern.CASE_INSENSITIVE);</span>

  private final ApplicationImpl application;

  private ApplicationField&lt;String&gt; description;
  private ApplicationField&lt;Boolean&gt; doesBotRequireCodeGrant;
  private ApplicationField&lt;Icon&gt; icon;
  private ApplicationField&lt;Boolean&gt; isBotPublic;
  private ApplicationField&lt;String&gt; name;
  private ApplicationField&lt;List&lt;String&gt;&gt; redirectUris;

<span class="nc" id="L63">  public ApplicationManagerUpdatable(final ApplicationImpl application) {</span>
<span class="nc" id="L64">    this.application = application;</span>

<span class="nc" id="L66">    this.setupFields();</span>
<span class="nc" id="L67">  }</span>

  /**
   * The {@link net.dv8tion.jda.core.JDA JDA} instance of this Manager
   *
   * @return the corresponding JDA instance
   */
  public JDA getJDA() {
<span class="nc" id="L75">    return this.application.getJDA();</span>
  }

  /**
   * The {@link net.dv8tion.jda.client.entities.Application Application} that will be modified by
   * this Manager instance
   *
   * @return The {@link net.dv8tion.jda.client.entities.Application Application}
   */
  public final Application getApplication() {
<span class="nc" id="L85">    return this.application;</span>
  }

  /**
   * An {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for the
   * &lt;b&gt;&lt;u&gt;description&lt;/u&gt;&lt;/b&gt; of the selected {@link net.dv8tion.jda.client.entities.Application
   * Application}.
   *
   * &lt;p&gt;To set the value use {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * setValue(String)} on the returned {@link
   * net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} instance.
   *
   * &lt;p&gt;A description &lt;b&gt;must not&lt;/b&gt; be more than 400 characters long! &lt;br&gt;
   * Otherwise {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * Field.setValue(...)} will throw an {@link IllegalArgumentException IllegalArgumentException}.
   *
   * @return {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} -
   *     Type: {@code String}
   */
  public final ApplicationField&lt;String&gt; getDescriptionField() {
<span class="nc" id="L105">    return this.description;</span>
  }

  /**
   * An {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for the
   * &lt;b&gt;&lt;u&gt;code grant state&lt;/u&gt;&lt;/b&gt; of the selected {@link
   * net.dv8tion.jda.client.entities.Application Application's} bot.
   *
   * &lt;p&gt;To set the value use {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * setValue(Boolean)} on the returned {@link
   * net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} instance.
   *
   * &lt;p&gt;A code grant state &lt;b&gt;must not&lt;/b&gt; be {@code null}! &lt;br&gt;
   * Otherwise {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * Field.setValue(...)} will throw an {@link IllegalArgumentException IllegalArgumentException}.
   *
   * @return {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} -
   *     Type: {@code Boolean}
   */
  public final ApplicationField&lt;Boolean&gt; getDoesBotRequireCodeGrantField() {
<span class="nc" id="L125">    return this.doesBotRequireCodeGrant;</span>
  }

  /**
   * An {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for the
   * {@link net.dv8tion.jda.core.entities.Icon Icon} of the selected {@link
   * net.dv8tion.jda.client.entities.Application Application}.
   *
   * &lt;p&gt;To set the value use {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * setValue(Icon)} on the returned {@link net.dv8tion.jda.client.managers.fields.ApplicationField
   * ApplicationField} instance.
   *
   * @return {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} -
   *     Type: {@link net.dv8tion.jda.core.entities.Icon Icon}
   */
  public final ApplicationField&lt;Icon&gt; getIconField() {
<span class="nc" id="L141">    return this.icon;</span>
  }

  /**
   * An {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for the
   * &lt;b&gt;&lt;u&gt;public state&lt;/u&gt;&lt;/b&gt; of the selected {@link net.dv8tion.jda.client.entities.Application
   * Application's} bot.
   *
   * &lt;p&gt;To set the value use {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * setValue(Boolean)} on the returned {@link
   * net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} instance.
   *
   * &lt;p&gt;A public state &lt;b&gt;must not&lt;/b&gt; be {@code null}! &lt;br&gt;
   * Otherwise {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * Field.setValue(...)} will throw an {@link IllegalArgumentException IllegalArgumentException}.
   *
   * @return {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} -
   *     Type: {@code Boolean}
   */
  public final ApplicationField&lt;Boolean&gt; getIsBotPublicField() {
<span class="nc" id="L161">    return this.isBotPublic;</span>
  }

  /**
   * An {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for the
   * &lt;b&gt;&lt;u&gt;name&lt;/u&gt;&lt;/b&gt; of the selected {@link net.dv8tion.jda.client.entities.Application
   * Application}.
   *
   * &lt;p&gt;To set the value use {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * setValue(String)} on the returned {@link
   * net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} instance.
   *
   * &lt;p&gt;A name &lt;b&gt;must not&lt;/b&gt; be {@code null} nor less than 2 characters or more than 32 characters
   * long! &lt;br&gt;
   * Otherwise {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * Field.setValue(...)} will throw an {@link IllegalArgumentException IllegalArgumentException}.
   *
   * @return {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} -
   *     Type: {@code String}
   */
  public final ApplicationField&lt;String&gt; getNameField() {
<span class="nc" id="L182">    return this.name;</span>
  }

  /**
   * An {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} for the
   * &lt;b&gt;&lt;u&gt;redirect uris&lt;/u&gt;&lt;/b&gt; of the selected {@link net.dv8tion.jda.client.entities.Application
   * Application}.
   *
   * &lt;p&gt;To set the value use {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * setValue(List)} on the returned {@link net.dv8tion.jda.client.managers.fields.ApplicationField
   * ApplicationField} instance.
   *
   * &lt;p&gt;Modification to the provided {@link java.util.List List} after passing it to this {@link
   * ApplicationManagerUpdatable} will be ignored.
   *
   * &lt;p&gt;The {@link java.util.List List} as well as all redirect uris &lt;b&gt;must not&lt;/b&gt; be {@code
   * null}! &lt;br&gt;
   * Otherwise {@link net.dv8tion.jda.core.managers.fields.Field#setValue(Object)
   * Field.setValue(...)} will throw an {@link IllegalArgumentException IllegalArgumentException}.
   *
   * @return {@link net.dv8tion.jda.client.managers.fields.ApplicationField ApplicationField} -
   *     Type: {@code List&lt;String&gt;}
   */
  public final ApplicationField&lt;List&lt;String&gt;&gt; getRedirectUrisField() {
<span class="nc" id="L206">    return this.redirectUris;</span>
  }

  /**
   * Resets all {@link net.dv8tion.jda.client.managers.fields.ApplicationField Fields} for this
   * manager instance by calling {@link net.dv8tion.jda.core.managers.fields.Field#reset()
   * Field.reset()} sequentially &lt;br&gt;
   * This is automatically called by {@link #update()}
   */
  public void reset() {
<span class="nc" id="L216">    this.description.reset();</span>
<span class="nc" id="L217">    this.doesBotRequireCodeGrant.reset();</span>
<span class="nc" id="L218">    this.icon.reset();</span>
<span class="nc" id="L219">    this.isBotPublic.reset();</span>
<span class="nc" id="L220">    this.name.reset();</span>
<span class="nc" id="L221">    this.redirectUris.reset();</span>
<span class="nc" id="L222">  }</span>

  protected boolean needsUpdate() {
<span class="nc bnc" id="L225" title="All 2 branches missed.">    return this.description.shouldUpdate()</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        || this.doesBotRequireCodeGrant.shouldUpdate()</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        || this.icon.shouldUpdate()</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        || this.isBotPublic.shouldUpdate()</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">        || this.name.shouldUpdate()</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        || this.redirectUris.shouldUpdate();</span>
  }

  protected void setupFields() {
<span class="nc" id="L234">    this.description =</span>
<span class="nc" id="L235">        new ApplicationField&lt;String&gt;(this, this.application::getDescription) {</span>
          @Override
          public void checkValue(final String value) {
<span class="nc bnc" id="L238" title="All 4 branches missed.">            if (value != null &amp;&amp; value.length() &gt; 400)</span>
<span class="nc" id="L239">              throw new IllegalArgumentException(</span>
                  &quot;application description must not be more than 400 characters long&quot;);
<span class="nc" id="L241">          }</span>
        };

<span class="nc" id="L244">    this.doesBotRequireCodeGrant =</span>
<span class="nc" id="L245">        new ApplicationField&lt;Boolean&gt;(this, this.application::doesBotRequireCodeGrant) {</span>
          @Override
          public void checkValue(final Boolean value) {
<span class="nc" id="L248">            Checks.notNull(value, &quot;doesBotRequireCodeGrant&quot;);</span>
<span class="nc" id="L249">          }</span>
        };

<span class="nc" id="L252">    this.icon =</span>
<span class="nc" id="L253">        new ApplicationField&lt;Icon&gt;(this, null) {</span>
          @Override
<span class="nc" id="L255">          public void checkValue(final Icon value) {}</span>

          @Override
          public Icon getOriginalValue() {
<span class="nc" id="L259">            throw new UnsupportedOperationException(</span>
                &quot;Cannot easily provide the original Avatar. Use Application#getIconUrl() and download it yourself.&quot;);
          }

          @Override
          public boolean shouldUpdate() {
<span class="nc" id="L265">            return this.isSet();</span>
          }
        };

<span class="nc" id="L269">    this.isBotPublic =</span>
<span class="nc" id="L270">        new ApplicationField&lt;Boolean&gt;(this, this.application::isBotPublic) {</span>
          @Override
          public void checkValue(final Boolean value) {
<span class="nc" id="L273">            Checks.notNull(value, &quot;isBotPublic&quot;);</span>
<span class="nc" id="L274">          }</span>
        };

<span class="nc" id="L277">    this.name =</span>
<span class="nc" id="L278">        new ApplicationField&lt;String&gt;(this, this.application::getName) {</span>
          @Override
          public void checkValue(final String value) {
<span class="nc" id="L281">            Checks.notNull(value, &quot;application name&quot;);</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">            if (value.length() &lt; 2 || value.length() &gt; 32)</span>
<span class="nc" id="L283">              throw new IllegalArgumentException(</span>
                  &quot;Application name must be 2 to 32 characters in length&quot;);
<span class="nc" id="L285">          }</span>
        };

<span class="nc" id="L288">    this.redirectUris =</span>
<span class="nc" id="L289">        new ApplicationField&lt;List&lt;String&gt;&gt;(this, this.application::getRedirectUris) {</span>
          @Override
          public void checkValue(final List&lt;String&gt; value) {
<span class="nc" id="L292">            Checks.notNull(value, &quot;redirect uris&quot;);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            for (final String url : value) {</span>

<span class="nc" id="L295">              Checks.notNull(url, &quot;redirect uri&quot;);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">              if (!ApplicationManagerUpdatable.URL_PATTERN.matcher(url).matches())</span>
<span class="nc" id="L297">                throw new IllegalArgumentException(&quot;URL must be a valid http or https url.&quot;);</span>
<span class="nc" id="L298">            }</span>
<span class="nc" id="L299">          }</span>

          @Override
          public ApplicationManagerUpdatable setValue(List&lt;String&gt; value) {
<span class="nc" id="L303">            checkValue(value);</span>

<span class="nc" id="L305">            this.value = Collections.unmodifiableList(new ArrayList&lt;&gt;(value));</span>
<span class="nc" id="L306">            this.set = true;</span>

<span class="nc" id="L308">            return manager;</span>
          }
        };
<span class="nc" id="L311">  }</span>

  /**
   * Creates a new {@link net.dv8tion.jda.core.requests.RestAction RestAction} instance that will
   * apply &lt;b&gt;all&lt;/b&gt; changes that have been made to this manager instance (one per runtime per JDA
   * instance).
   *
   * &lt;p&gt;Before applying new changes it is recommended to call {@link #reset()} to reset previous
   * changes. &lt;br&gt;
   * This is automatically called if this method returns successfully.
   *
   * @return {@link net.dv8tion.jda.core.requests.RestAction RestAction} - Type: Void &lt;br&gt;
   *     Updates all modified fields or does nothing if none of the {@link
   *     net.dv8tion.jda.core.managers.fields.Field Fields} have been modified. ({@link
   *     net.dv8tion.jda.core.requests.RestAction.EmptyRestAction EmptyRestAction})
   */
  public RestAction&lt;Void&gt; update() {
<span class="nc bnc" id="L328" title="All 2 branches missed.">    if (!this.needsUpdate()) return new RestAction.EmptyRestAction&lt;&gt;(getJDA(), null);</span>

<span class="nc" id="L330">    final JSONObject body = new JSONObject();</span>

    // All fields are required or they are resetted to default

<span class="nc" id="L334">    body.put(</span>
        &quot;description&quot;,
<span class="nc bnc" id="L336" title="All 2 branches missed.">        this.description.shouldUpdate()</span>
<span class="nc" id="L337">            ? this.description.getValue()</span>
<span class="nc" id="L338">            : this.description.getOriginalValue());</span>

<span class="nc" id="L340">    body.put(</span>
        &quot;bot_require_code_grant&quot;,
<span class="nc bnc" id="L342" title="All 2 branches missed.">        this.doesBotRequireCodeGrant.shouldUpdate()</span>
<span class="nc" id="L343">            ? this.doesBotRequireCodeGrant.getValue()</span>
<span class="nc" id="L344">            : this.doesBotRequireCodeGrant.getOriginalValue());</span>

<span class="nc" id="L346">    body.put(</span>
        &quot;icon&quot;,
<span class="nc bnc" id="L348" title="All 2 branches missed.">        this.icon.shouldUpdate()</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">            ? this.icon.getValue() == null ? JSONObject.NULL : this.icon.getValue().getEncoding()</span>
<span class="nc" id="L350">            : this.application.getIconUrl());</span>

<span class="nc" id="L352">    body.put(</span>
        &quot;bot_public&quot;,
<span class="nc bnc" id="L354" title="All 2 branches missed.">        this.isBotPublic.shouldUpdate()</span>
<span class="nc" id="L355">            ? this.isBotPublic.getValue()</span>
<span class="nc" id="L356">            : this.isBotPublic.getOriginalValue());</span>

<span class="nc" id="L358">    body.put(</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">        &quot;name&quot;, this.name.shouldUpdate() ? this.name.getValue() : this.name.getOriginalValue());</span>

<span class="nc" id="L361">    body.put(</span>
        &quot;redirect_uris&quot;,
<span class="nc bnc" id="L363" title="All 2 branches missed.">        this.redirectUris.shouldUpdate()</span>
<span class="nc" id="L364">            ? this.redirectUris.getValue()</span>
<span class="nc" id="L365">            : this.redirectUris.getOriginalValue());</span>

<span class="nc" id="L367">    reset(); // now that we've built our JSON object, reset the manager back to the non-modified</span>
    // state

<span class="nc" id="L370">    Route.CompiledRoute route =</span>
<span class="nc" id="L371">        Route.Applications.MODIFY_APPLICATION.compile(this.application.getId());</span>
<span class="nc" id="L372">    return new RestAction&lt;Void&gt;(this.getJDA(), route, body) {</span>
      @Override
      protected void handleResponse(final Response response, final Request&lt;Void&gt; request) {
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (response.isOk()) {</span>
<span class="nc" id="L376">          ApplicationManagerUpdatable.this.application.updateFromJson(response.getObject());</span>
<span class="nc" id="L377">          request.onSuccess(null);</span>
<span class="nc" id="L378">        } else request.onFailure(response);</span>
<span class="nc" id="L379">      }</span>
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>